{% extends "_layouts/cp" %}

{% set title = "Plugin Sales"|t('plugin-sales') %}

{% do view.registerCssFile('https://cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css') %}
{% do view.registerJsFile('https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js',{
    depends: ['craft\\web\\assets\\cp\\CpAsset']
}) %}
{% do view.registerJsFile('https://cdn.jsdelivr.net/npm/apexcharts') %}


{% block content %}

    <div id="chart"></div>

    <br><br>

    <table id="plugin-sales">
        <thead>
            <tr>
                <th>{{ 'Plugin'|t('plugin-sales') }}</th>
                <th>{{ 'Edition'|t('plugin-sales') }}</th>
                <th>{{ 'Type'|t('plugin-sales') }}</th>
                <th>{{ 'Customer'|t('plugin-sales') }}</th>
                <th>{{ 'Gross Amount'|t('plugin-sales') }}</th>
                <th>{{ 'Net Amount'|t('plugin-sales') }}</th>
                <th>{{ 'Date'|t('plugin-sales') }}</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

{% endblock %}

{% js %}

    $('#plugin-sales').DataTable({
        data: {{ craft.pluginSales.getSalesData()|raw }}
    });

    {% set monthlyTotals = craft.pluginSales.getMonthlyTotals() %}

    var options = {
        series: [
            {
                name: "Gross Amount",
                data: [
                    {% for monthlyTotal in monthlyTotals %}
                        '{{ monthlyTotal.grossAmount }}',
                    {% endfor %}
                ]
            },
            {
                name: "Net Amount",
                data: [
                    {% for monthlyTotal in monthlyTotals %}
                        '{{ monthlyTotal.netAmount }}',
                    {% endfor %}
                ]
            },
            {
                name: "Licenses",
                data: [
                    {% for monthlyTotal in monthlyTotals %}
                        '{{ monthlyTotal.count }}',
                    {% endfor %}
                ]
            },
        ],
        chart: {
            height: 400,
            type: 'area',
            zoom: {
                enabled: false
            }
        },
        dataLabels: {
            enabled: false
        },
        stroke: {
            curve: 'straight'
        },
        grid: {
            row: {
                colors: ['#f3f3f3', 'transparent'], // takes an array which will be repeated on columns
                opacity: 0.5
            },
        },
        xaxis: {
            categories: [
                {% for monthlyTotal in monthlyTotals %}
                    '{{ monthlyTotal.month }}-{{ monthlyTotal.year }}',
                {% endfor %}
            ],
            labels: {
                style: {
                    colors: '#888',
                },
            }
        },
        yaxis: [
            {
                seriesName: 'USD',
                title: {
                    text: "USD"
                },
                labels: {
                    style: {
                        colors: '#888',
                    },
                    formatter: function(val) {
                        return Math.round(val);
                    },
                }
            },
            {
                seriesName: 'USD',
                show: false,
            },
            {
                seriesName: 'Licenses',
                opposite: true,
                title: {
                    text: "Licenses"
                },
                labels: {
                    style: {
                        colors: '#888',
                    },
                    formatter: function(val) {
                        return Math.round(val);
                    },
                }
            }
        ],
        legend: {
            position: 'top',
        },
    };

    var chart = new ApexCharts(document.querySelector("#chart"), options);
    chart.render();

{% endjs %}
